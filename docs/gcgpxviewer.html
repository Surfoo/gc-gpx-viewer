<!DOCTYPE html>

<html>
<head>
  <title>gcgpxviewer.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>gcgpxviewer.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <pre><code>gcgpxviewer.js <span class="hljs-number">2.0</span><span class="hljs-number">.6</span>
https:<span class="hljs-comment">//gc-gpx-viewer.vaguelibre.net/</span>
(c) <span class="hljs-number">2014</span> - Surfoo
email: surfooo at gmail dot com 
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>‘use strict’;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">var</span> typeCaches, sizeCaches, circle, control, map, parser, doc,
        objOptionLabel = document.getElementById(<span class="hljs-string">'display_labels'</span>),
        objOptionPerimeter = document.getElementById(<span class="hljs-string">'display_perimeters'</span>),
        circleList = [],
        polylineList = [],
        markers = [],
        circleOpacity = <span class="hljs-number">0.8</span>,
        circleColor = <span class="hljs-string">'#c11414'</span>,
        circleFillOpacity = <span class="hljs-number">0.25</span>,
        unitType = [<span class="hljs-string">'o'</span>, <span class="hljs-string">'Ko'</span>, <span class="hljs-string">'Mo'</span>, <span class="hljs-string">'Go'</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Types of geocaches from geocaching.com
The key is the term used in the GPX file and the value is used for the filename below</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    typeCaches = {
        <span class="hljs-string">'Traditional Cache'</span>: <span class="hljs-string">'type_traditional'</span>,
        <span class="hljs-string">'Multi-cache'</span>: <span class="hljs-string">'type_multi'</span>,
        <span class="hljs-string">'Virtual Cache'</span>: <span class="hljs-string">'type_virtual'</span>,
        <span class="hljs-string">'Letterbox Hybrid'</span>: <span class="hljs-string">'type_letterbox'</span>,
        <span class="hljs-string">'Event Cache'</span>: <span class="hljs-string">'type_event'</span>,
        <span class="hljs-string">'Unknown Cache'</span>: <span class="hljs-string">'type_mystery'</span>,
        <span class="hljs-string">'Mystery Cache'</span>: <span class="hljs-string">'type_mystery'</span>,
        <span class="hljs-string">'Project APE Cache'</span>: <span class="hljs-string">'type_ape'</span>,
        <span class="hljs-string">'Webcam Cache'</span>: <span class="hljs-string">'type_webcam'</span>,
        <span class="hljs-string">'Cache In Trash Out Event'</span>: <span class="hljs-string">'type_cito'</span>,
        <span class="hljs-string">'Earthcache'</span>: <span class="hljs-string">'type_earth'</span>,
        <span class="hljs-string">'Mega-Event Cache'</span>: <span class="hljs-string">'type_mega'</span>,
        <span class="hljs-string">'GPS Adventures Exhibit'</span>: <span class="hljs-string">'type_event'</span>,
        <span class="hljs-string">'Wherigo Cache'</span>: <span class="hljs-string">'type_wherigo'</span>,
        <span class="hljs-string">'Lost and Found Event Caches'</span>: <span class="hljs-string">'type_event'</span>,
        <span class="hljs-string">'Groundspeak HQ'</span>: <span class="hljs-string">'type_hq'</span>,
        <span class="hljs-string">'Groundspeak Lost and Found Celebration'</span>: <span class="hljs-string">'type_event'</span>,
        <span class="hljs-string">'Groundspeak Block Party'</span>: <span class="hljs-string">'type_event'</span>,
        <span class="hljs-string">'Giga-Event Cache'</span>: <span class="hljs-string">'type_giga'</span>
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Size list geocaches</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    sizeCaches = {
        <span class="hljs-string">'micro'</span>: <span class="hljs-string">'Micro'</span>,
        <span class="hljs-string">'small'</span>: <span class="hljs-string">'Small'</span>,
        <span class="hljs-string">'regular'</span>: <span class="hljs-string">'Regular'</span>,
        <span class="hljs-string">'large'</span>: <span class="hljs-string">'Large'</span>,
        <span class="hljs-string">'not_chosen'</span>: <span class="hljs-string">'Not chosen'</span>,
        <span class="hljs-string">'not chosen'</span>: <span class="hljs-string">'Not chosen'</span>,
        <span class="hljs-string">'unknown'</span>: <span class="hljs-string">'Unknown'</span>,
        <span class="hljs-string">'other'</span>: <span class="hljs-string">'Other'</span>,
        <span class="hljs-string">'virtual'</span>: <span class="hljs-string">'Virtual'</span>
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Display geocaches on the map</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> displayCaches = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(wpts)</span> {</span>
        <span class="hljs-keyword">var</span> icon, wpt, sym, latlng, oMarker, infoContent, i, nbWpts, grdspk, elmGccode, elmName, elmDifficulty,
            elmTerrain, elmOwner, elmContainer, elmType, elmDate, elmSize, iconFile;</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>for each geocaches</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, nbWpts = wpts.length; i &lt; nbWpts; ++i) {
            wpt = wpts[i];
            sym = wpt.getElementsByTagName(<span class="hljs-string">'sym'</span>)[<span class="hljs-number">0</span>].childNodes[<span class="hljs-number">0</span>] || <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">if</span> (sym &amp;&amp; (sym.nodeValue !== <span class="hljs-string">'Geocache'</span> &amp;&amp;
                    sym.nodeValue !== <span class="hljs-string">'Geocache Found'</span> &amp;&amp;
                    sym.nodeValue !== <span class="hljs-string">''</span>)) {
                <span class="hljs-keyword">continue</span>;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Retrieve all informations in the waypoint</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            grdspk = wpt.getElementsByTagNameNS(<span class="hljs-string">'*'</span>, <span class="hljs-string">'cache'</span>);
            <span class="hljs-comment">/*console.log(grdspk[0].getAttribute('id'));*/</span>
            elmGccode = wpt.getElementsByTagName(<span class="hljs-string">'name'</span>)[<span class="hljs-number">0</span>].childNodes[<span class="hljs-number">0</span>].nodeValue;
            elmName = grdspk[<span class="hljs-number">0</span>].getElementsByTagNameNS(<span class="hljs-string">'*'</span>, <span class="hljs-string">'name'</span>);
            elmDifficulty = grdspk[<span class="hljs-number">0</span>].getElementsByTagNameNS(<span class="hljs-string">'*'</span>, <span class="hljs-string">'difficulty'</span>);
            elmDifficulty = elmDifficulty[<span class="hljs-number">0</span>].childNodes[<span class="hljs-number">0</span>].nodeValue;
            elmTerrain = grdspk[<span class="hljs-number">0</span>].getElementsByTagNameNS(<span class="hljs-string">'*'</span>, <span class="hljs-string">'terrain'</span>);
            elmTerrain = elmTerrain[<span class="hljs-number">0</span>].childNodes[<span class="hljs-number">0</span>].nodeValue;
            elmOwner = grdspk[<span class="hljs-number">0</span>].getElementsByTagNameNS(<span class="hljs-string">'*'</span>, <span class="hljs-string">'owner'</span>);
            elmContainer = grdspk[<span class="hljs-number">0</span>].getElementsByTagNameNS(<span class="hljs-string">'*'</span>, <span class="hljs-string">'container'</span>);
            elmContainer = elmContainer[<span class="hljs-number">0</span>].childNodes[<span class="hljs-number">0</span>].nodeValue.toLowerCase();
            elmType = grdspk[<span class="hljs-number">0</span>].getElementsByTagNameNS(<span class="hljs-string">'*'</span>, <span class="hljs-string">'type'</span>);
            elmType = elmType[<span class="hljs-number">0</span>].childNodes[<span class="hljs-number">0</span>].nodeValue;
            elmDate = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(wpt.getElementsByTagName(<span class="hljs-string">'time'</span>)[<span class="hljs-number">0</span>].childNodes[<span class="hljs-number">0</span>].nodeValue);
            elmDate = elmDate.format(<span class="hljs-string">'yyyy/mm/dd'</span>);
            elmSize = sizeCaches.unknown;
            iconFile = <span class="hljs-string">'type_unknown'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Search for the cache icon</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (_.has(typeCaches, elmType)) {
                iconFile = typeCaches[elmType];
            }
            icon = L.icon({
                iconSize: [<span class="hljs-number">22</span>, <span class="hljs-number">22</span>],
                iconUrl: <span class="hljs-string">'img/'</span> + iconFile + <span class="hljs-string">'.map.png'</span>,
                iconPopin: <span class="hljs-string">'img/'</span> + iconFile + <span class="hljs-string">'.png'</span>
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Search for the cache size</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (_.has(sizeCaches, elmContainer)) {
                elmSize = sizeCaches[elmContainer];
            }

            latlng = <span class="hljs-keyword">new</span> L.latLng(<span class="hljs-built_in">parseFloat</span>(wpt.getAttribute(<span class="hljs-string">'lat'</span>)), <span class="hljs-built_in">parseFloat</span>(wpt.getAttribute(<span class="hljs-string">'lon'</span>)));</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Create the marker</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            oMarker = L.marker(latlng, {
                icon: icon
            }).bindLabel(elmGccode, {
                opacity: objOptionLabel.checked ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>,
                noHide: <span class="hljs-literal">true</span>,
                direction: <span class="hljs-string">'auto'</span>
            }).addTo(map);</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Content for the popup</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            infoContent = <span class="hljs-string">'&lt;div class="infowindow"&gt;'</span>;
            infoContent += <span class="hljs-string">'&lt;div class="code"&gt;'</span> + elmGccode + <span class="hljs-string">'&lt;/div&gt;'</span>;
            infoContent += <span class="hljs-string">'    &lt;h4&gt;'</span>;
            infoContent += <span class="hljs-string">'        &lt;img src="'</span> + icon.options.iconPopin + <span class="hljs-string">'" width="20" alt="" /&gt;'</span>;
            infoContent += <span class="hljs-string">'        &lt;a href="https://coord.info/'</span> + <span class="hljs-built_in">encodeURIComponent</span>(elmGccode) + <span class="hljs-string">'" onclick="window.open(this.href);return false;" title="'</span> + elmName[<span class="hljs-number">0</span>].childNodes[<span class="hljs-number">0</span>].nodeValue + <span class="hljs-string">'"&gt;'</span> + elmName[<span class="hljs-number">0</span>].childNodes[<span class="hljs-number">0</span>].nodeValue + <span class="hljs-string">'&lt;/a&gt;'</span>;
            infoContent += <span class="hljs-string">'    &lt;/h4&gt;'</span>;
            infoContent += <span class="hljs-string">'    &lt;dl style="float:left;margin-right:2em;width:50%;"&gt;'</span>;
            <span class="hljs-keyword">if</span> (elmOwner[<span class="hljs-number">0</span>].childNodes[<span class="hljs-number">0</span>]) {
                infoContent += <span class="hljs-string">'        &lt;dt&gt;Created by:&lt;/dt&gt;'</span>;
                infoContent += <span class="hljs-string">'        &lt;dd title="'</span> + elmOwner[<span class="hljs-number">0</span>].childNodes[<span class="hljs-number">0</span>].nodeValue + <span class="hljs-string">'"&gt;'</span>;
                infoContent += <span class="hljs-string">'&lt;a href="https://www.geocaching.com/profile/?u='</span> + <span class="hljs-built_in">encodeURIComponent</span>(elmOwner[<span class="hljs-number">0</span>].childNodes[<span class="hljs-number">0</span>].nodeValue) + <span class="hljs-string">'" onclick="window.open(this.href);return false;"&gt;'</span> + elmOwner[<span class="hljs-number">0</span>].childNodes[<span class="hljs-number">0</span>].nodeValue + <span class="hljs-string">'&lt;/a&gt;&lt;/dd&gt;'</span>;
            }
            infoContent += <span class="hljs-string">'        &lt;dt&gt;Difficulty:&lt;/dt&gt;'</span>;
            infoContent += <span class="hljs-string">'        &lt;dd&gt;'</span> + elmDifficulty + <span class="hljs-string">'&lt;/dd&gt;'</span>;
            infoContent += <span class="hljs-string">'        &lt;dt&gt;Cache size:&lt;/dt&gt;'</span>;
            infoContent += <span class="hljs-string">'        &lt;dd&gt;'</span> + elmSize + <span class="hljs-string">'&lt;/dd&gt;'</span>;
            infoContent += <span class="hljs-string">'    &lt;/dl&gt;'</span>;
            infoContent += <span class="hljs-string">'    &lt;dl style="margin-left:50%"&gt;'</span>;
            infoContent += <span class="hljs-string">'        &lt;dt&gt;Date Hidden:&lt;/dt&gt;'</span>;
            infoContent += <span class="hljs-string">'        &lt;dd&gt;'</span> + elmDate + <span class="hljs-string">'&lt;/dd&gt;'</span>;
            infoContent += <span class="hljs-string">'        &lt;dt&gt;Terrain:&lt;/dt&gt;'</span>;
            infoContent += <span class="hljs-string">'        &lt;dd&gt;'</span> + elmTerrain + <span class="hljs-string">'&lt;/dd&gt;'</span>;
            infoContent += <span class="hljs-string">'    &lt;/dl&gt;'</span>;
            infoContent += <span class="hljs-string">'&lt;/div&gt;'</span>;

            oMarker.bindPopup(L.popup({
                maxWidth: <span class="hljs-number">500</span>
            }).setLatLng(latlng).setContent(infoContent));
            markers.push(oMarker);</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Set perimeter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            circle = <span class="hljs-keyword">new</span> L.circle(latlng, <span class="hljs-number">161</span>, {
                weight: <span class="hljs-number">2</span>,
                color: circleColor,
                opacity: objOptionPerimeter.checked ? circleOpacity : <span class="hljs-number">0</span>,
                fillColor: objOptionPerimeter.checked ? circleColor : <span class="hljs-string">'transparent'</span>,
                fillOpacity: objOptionPerimeter.checked ? circleFillOpacity : <span class="hljs-number">0</span>,
                clickable: <span class="hljs-literal">false</span>
            });
            circle.addTo(map);
            circleList.push(circle);</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Extends the bounds to contain the given point</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            bounds.extend(latlng);
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Display tracks on the map</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> displayTracks = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(wpts)</span> {</span>
        <span class="hljs-keyword">var</span> wpt, latlng, i = <span class="hljs-number">0</span>,
            j, k,
            nb = wpts.length,
            trksegs, trkseg, trkpts, trkpt, nbTrkSegs, nbTrkPts, path;

        <span class="hljs-keyword">for</span> (i; i &lt; nb; ++i) {
            wpt = wpts[i];
            trksegs = wpt.getElementsByTagName(<span class="hljs-string">'trkseg'</span>);

            <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>, nbTrkSegs = trksegs.length; j &lt; nbTrkSegs; ++j) {
                trkseg = trksegs[j];
                path = [];
                trkpts = trkseg.getElementsByTagName(<span class="hljs-string">'trkpt'</span>);
                <span class="hljs-keyword">for</span> (k = <span class="hljs-number">0</span>, nbTrkPts = trkpts.length; k &lt; nbTrkPts; ++k) {
                    trkpt = trkpts[k];
                    latlng = <span class="hljs-keyword">new</span> L.latLng(<span class="hljs-built_in">parseFloat</span>(trkpt.getAttribute(<span class="hljs-string">'lat'</span>)), <span class="hljs-built_in">parseFloat</span>(trkpt.getAttribute(<span class="hljs-string">'lon'</span>)));
                    path.push(latlng);
                    bounds.extend(latlng);
                }
                <span class="hljs-keyword">var</span> polyline = <span class="hljs-keyword">new</span> L.Polyline(path, {
                    color: <span class="hljs-string">'red'</span>
                });
                polyline.addTo(map);
                polylineList.push(polyline);
            }
        }

    };</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>function to display informations on the maps, waypoints or tracks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> display = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
        <span class="hljs-keyword">var</span> waypoints = data.documentElement.getElementsByTagName(<span class="hljs-string">'wpt'</span>),
            trks = data.documentElement.getElementsByTagName(<span class="hljs-string">'trk'</span>);
        <span class="hljs-keyword">if</span> (waypoints.length === <span class="hljs-number">0</span> &amp;&amp; trks.length === <span class="hljs-number">0</span>) {
            alert(<span class="hljs-string">'No waypoints found.'</span>);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (waypoints.length &gt; <span class="hljs-number">0</span>) {
            displayCaches(waypoints);
        }

        <span class="hljs-keyword">if</span> (waypoints.length === <span class="hljs-number">0</span> &amp;&amp; trks.length === <span class="hljs-number">0</span>) {
            alert(<span class="hljs-string">'No tracks found.'</span>);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (trks.length &gt; <span class="hljs-number">0</span>) {
            displayTracks(trks);
        }

        <span class="hljs-keyword">if</span> (bounds.isValid()) {
            map.fitBounds(bounds);
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Toggle labels according to the old value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> toggleLabels = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        _.each(markers, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, key)</span> {</span>
            <span class="hljs-keyword">if</span> (objOptionLabel.checked) {
                markers[key].setOpacity(<span class="hljs-number">1</span>, <span class="hljs-literal">true</span>);
                markers[key].showLabel();
            } <span class="hljs-keyword">else</span> {
                markers[key].hideLabel();
            }
        });

        localStorage.setItem(<span class="hljs-string">'option_label'</span>, +objOptionLabel.checked);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Toggle perimeters acccording to the old value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> togglePerimeters = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        _.each(markers, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, key)</span> {</span>
            circleList[key].setStyle({
                opacity: objOptionPerimeter.checked ? circleOpacity : <span class="hljs-number">0</span>,
                fillColor: objOptionPerimeter.checked ? circleColor : <span class="hljs-string">'transparent'</span>,
                fillOpacity: objOptionPerimeter.checked ? circleFillOpacity : <span class="hljs-number">0</span>
            });
        });

        localStorage.setItem(<span class="hljs-string">'option_perimeter'</span>, +objOptionPerimeter.checked);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Clear the map by removing all layers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> clear = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        _.each(circleList, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, key)</span> {</span>
            map.removeLayer(circleList[key]);
        });
        _.each(markers, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, key)</span> {</span>
            map.removeLayer(markers[key]);
        });
        _.each(polylineList, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, key)</span> {</span>
            map.removeLayer(polylineList[key]);
        });

        circleList.length = <span class="hljs-number">0</span>;
        markers.length = <span class="hljs-number">0</span>;
        polylineList.length = <span class="hljs-number">0</span>;
        bounds = <span class="hljs-keyword">new</span> L.LatLngBounds();

        <span class="hljs-keyword">var</span> element = document.getElementById(<span class="hljs-string">'list'</span>);
        <span class="hljs-keyword">while</span> (element.firstChild) {
            element.removeChild(element.firstChild);
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Save the position and the zoom in localstorage</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> savePosition = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        localStorage.setItem(<span class="hljs-string">'zoom'</span>, map.getZoom());
        localStorage.setItem(<span class="hljs-string">'latitude'</span>, map.getCenter().lat.toFixed(<span class="hljs-number">5</span>));
        localStorage.setItem(<span class="hljs-string">'longitude'</span>, map.getCenter().lng.toFixed(<span class="hljs-number">5</span>));
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Save the position of the sidebard (hidden or not)  in localstorage</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> saveSidebar = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        localStorage.setItem(<span class="hljs-string">'sidebar'</span>, +sidebar.isVisible());
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Save the current baselayer  in localstorage</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> saveBaseLayer = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        localStorage.setItem(<span class="hljs-string">'baselayer'</span>, control.getActiveBaseLayer().name);
    };

    <span class="hljs-keyword">var</span> bounds = <span class="hljs-keyword">new</span> L.LatLngBounds();</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Init function to create the user interface</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> load = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">var</span> mapboxAccessToken = <span class="hljs-string">'pk.eyJ1Ijoic3VyZm9vIiwiYSI6InpDWEQxRFkifQ.fclPYEBfTQBOmMGeUHJkKw'</span>;

        <span class="hljs-keyword">var</span> mapboxLayer = L.tileLayer(<span class="hljs-string">'https://{s}.tiles.mapbox.com/v4/surfoo.la14jo4j/{z}/{x}/{y}.png?access_token='</span> + mapboxAccessToken);

        <span class="hljs-keyword">var</span> osmLegacyLayer = L.tileLayer(<span class="hljs-string">'https://tile.openstreetmap.org/{z}/{x}/{y}.png'</span>, {
            maxZoom: <span class="hljs-number">18</span>,
            minZoom: <span class="hljs-number">3</span>,
            attribution: <span class="hljs-string">'Map data &amp;copy; &lt;a href="http://openstreetmap.org"&gt;OpenStreetMap&lt;/a&gt; contributors, &lt;a href="http://creativecommons.org/licenses/by-sa/2.0/"&gt;CC-BY-SA&lt;/a&gt;, Imagery © &lt;a href="http://www.openstreetmap.org/"&gt;OpenStreetMap&lt;/a&gt;'</span>
        });

        <span class="hljs-keyword">var</span> bingLayerAerial = <span class="hljs-keyword">new</span> L.BingLayer(<span class="hljs-string">"AlBwVzyGYtseSIzUAiDWBVI6k8OLGHVnEYuSfWSzNtQJ7eltNWiL1wCkdbD6T_JJ"</span>, {
            type: <span class="hljs-string">'Aerial'</span>
        });

        <span class="hljs-keyword">var</span> bingLayerAerialWithLabels = <span class="hljs-keyword">new</span> L.BingLayer(<span class="hljs-string">"AlBwVzyGYtseSIzUAiDWBVI6k8OLGHVnEYuSfWSzNtQJ7eltNWiL1wCkdbD6T_JJ"</span>, {
            type: <span class="hljs-string">'AerialWithLabels'</span>
        });

        <span class="hljs-keyword">var</span> bingLayerRoad = <span class="hljs-keyword">new</span> L.BingLayer(<span class="hljs-string">"AlBwVzyGYtseSIzUAiDWBVI6k8OLGHVnEYuSfWSzNtQJ7eltNWiL1wCkdbD6T_JJ"</span>, {
            type: <span class="hljs-string">'Road'</span>
        });

        <span class="hljs-keyword">var</span> stamenToner = <span class="hljs-keyword">new</span> L.StamenTileLayer(<span class="hljs-string">"toner"</span>);

        <span class="hljs-keyword">var</span> stamenWaterColor = <span class="hljs-keyword">new</span> L.StamenTileLayer(<span class="hljs-string">"watercolor"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Default values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> currentLatitude = <span class="hljs-number">46</span>,
            currentLongitude = <span class="hljs-number">2.9</span>,
            currentZoom = <span class="hljs-number">6</span>,
            currentSidebar = <span class="hljs-number">1</span>,
            currentBaseLayer = <span class="hljs-string">'OSM Legacy'</span>,
            option_label = <span class="hljs-number">1</span>,
            option_perimeter = <span class="hljs-number">1</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>List of base layers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> baseLayers = {
            <span class="hljs-string">"OSM Legacy"</span>: osmLegacyLayer,
            <span class="hljs-string">"Bing Aerial"</span>: bingLayerAerial,
            <span class="hljs-string">"Bing Road"</span>: bingLayerRoad,
            <span class="hljs-string">"Bing Hybrid"</span>: bingLayerAerialWithLabels,
            <span class="hljs-string">"MapBox Light"</span>: mapboxLayer,
            <span class="hljs-string">"Stamen Toner"</span>: stamenToner,
            <span class="hljs-string">"Stamen WaterColor"</span>: stamenWaterColor
        };

        <span class="hljs-keyword">var</span> overlays = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Set some of default values for the map</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (window.localStorage) {
            currentLatitude = _.isNull(localStorage.getItem(<span class="hljs-string">'latitude'</span>)) ? currentLatitude : <span class="hljs-built_in">parseFloat</span>(localStorage.getItem(<span class="hljs-string">'latitude'</span>));
            currentLongitude = _.isNull(localStorage.getItem(<span class="hljs-string">'longitude'</span>)) ? currentLongitude : <span class="hljs-built_in">parseFloat</span>(localStorage.getItem(<span class="hljs-string">'longitude'</span>));
            currentZoom = _.isNull(localStorage.getItem(<span class="hljs-string">'zoom'</span>)) ? currentZoom : +localStorage.getItem(<span class="hljs-string">'zoom'</span>);
            <span class="hljs-keyword">if</span> (localStorage.getItem(<span class="hljs-string">'baselayer'</span>) !== <span class="hljs-literal">null</span> &amp;&amp; _.has(baseLayers, localStorage.getItem(<span class="hljs-string">'baselayer'</span>))) {
                currentBaseLayer = localStorage.getItem(<span class="hljs-string">'baselayer'</span>);
            }
            currentSidebar = localStorage.getItem(<span class="hljs-string">'sidebar'</span>) === <span class="hljs-literal">null</span> ? currentSidebar : +localStorage.getItem(<span class="hljs-string">'sidebar'</span>);
            option_label = localStorage.getItem(<span class="hljs-string">'option_label'</span>) === <span class="hljs-literal">null</span> ? option_label : +localStorage.getItem(<span class="hljs-string">'option_label'</span>);
            option_perimeter = localStorage.getItem(<span class="hljs-string">'option_perimeter'</span>) === <span class="hljs-literal">null</span> ? option_perimeter : +localStorage.getItem(<span class="hljs-string">'option_perimeter'</span>);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Create the map</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        map = L.map(<span class="hljs-string">'map'</span>, {
            center: <span class="hljs-keyword">new</span> L.LatLng(currentLatitude, currentLongitude),
            zoom: currentZoom,
            layers: _.values(_.pick(baseLayers, currentBaseLayer)),
            attributionControl: <span class="hljs-literal">false</span>,
            zoomControl: <span class="hljs-literal">true</span>,
            inertia: <span class="hljs-literal">false</span>
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Active Layers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        control = L.control.activeLayers(baseLayers, overlays);
        control.addTo(map);</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Scale options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        L.control.scale({
            <span class="hljs-string">'maxWidth'</span>: <span class="hljs-number">200</span>
        }).addTo(map);</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Sidebar options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        sidebar = L.control.sidebar(<span class="hljs-string">'sidebar'</span>, {
            position: <span class="hljs-string">'left'</span>,
            autoPan: <span class="hljs-literal">false</span>
        });
        map.addControl(sidebar);
        document.getElementById(<span class="hljs-string">'sidebar'</span>).style.display = <span class="hljs-string">'block'</span>;
        <span class="hljs-keyword">if</span> (currentSidebar) {
            _.delay(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                sidebar.show();
            }, <span class="hljs-number">250</span>);
        }
        <span class="hljs-keyword">if</span> (option_label) {
            objOptionLabel.checked = <span class="hljs-string">'checked'</span>;
        }
        <span class="hljs-keyword">if</span> (option_perimeter) {
            objOptionPerimeter.checked = <span class="hljs-string">'checked'</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Fullscreen options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        map.addControl(<span class="hljs-keyword">new</span> L.Control.FullScreen());</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Geolocation options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        L.control.locate({
            drawCircle: <span class="hljs-literal">false</span>
        }).addTo(map);</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        map.addControl(<span class="hljs-keyword">new</span> L.Control.Options());</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>EventListeners</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        document.getElementById(<span class="hljs-string">'clear'</span>).addEventListener(<span class="hljs-string">'click'</span>, clear);
        objOptionLabel.addEventListener(<span class="hljs-string">'change'</span>, toggleLabels);
        objOptionPerimeter.addEventListener(<span class="hljs-string">'change'</span>, togglePerimeters);
        L.DomEvent.addListener(map, <span class="hljs-string">'zoomend'</span>, savePosition);
        L.DomEvent.addListener(map, <span class="hljs-string">'moveend'</span>, savePosition);
        L.DomEvent.addListener(map, <span class="hljs-string">'baselayerchange'</span>, saveBaseLayer);
        sidebar.on(<span class="hljs-string">'hide'</span>, saveSidebar);
        sidebar.on(<span class="hljs-string">'show'</span>, saveSidebar);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>App Cache, reload the web app by user request to get the latest version</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> onUpdateReady = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        _.delay(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (confirm(<span class="hljs-string">'Geocaching GPX Viewer has been updated!\n\nDo you want to reload the page to use the new version?'</span>)) {
                window.location.reload(<span class="hljs-literal">true</span>);
            }
        }, <span class="hljs-number">0</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Listener for App Cache</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    window.applicationCache.addEventListener(<span class="hljs-string">'updateready'</span>, onUpdateReady);
    <span class="hljs-keyword">if</span> (window.applicationCache.status === window.applicationCache.UPDATEREADY) {
        onUpdateReady();
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Flattr Button</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">var</span> f, s = document.getElementById(<span class="hljs-string">'flattr'</span>);
        f = document.createElement(<span class="hljs-string">'iframe'</span>);
        f.src = <span class="hljs-string">'//api.flattr.com/button/view/?uid=Surfoo&amp;button=compact&amp;url='</span> + <span class="hljs-built_in">encodeURIComponent</span>(document.URL);
        f.title = <span class="hljs-string">'Flattr'</span>;
        f.height = <span class="hljs-number">20</span>;
        f.width = <span class="hljs-number">110</span>;
        f.style.borderWidth = <span class="hljs-number">0</span>;
        f.style.verticalAlign = <span class="hljs-string">'middle'</span>;
        s.parentNode.insertBefore(f, s);
    }());</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Output information</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> Output = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(msg)</span> {</span>
        <span class="hljs-keyword">var</span> li = document.createElement(<span class="hljs-string">'li'</span>),
            list = document.getElementById(<span class="hljs-string">'list'</span>);
        li.innerHTML = msg;
        list.appendChild(li);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Output file information</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> ParseFile = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(file)</span> {</span>
        <span class="hljs-keyword">var</span> reader = <span class="hljs-keyword">new</span> FileReader(),
            el = document.getElementById(<span class="hljs-string">'loader'</span>),
            fileinfo = [{
                <span class="hljs-string">'name'</span>: file.name,
                <span class="hljs-string">'size'</span>: file.size
            }];

        reader.onprogress = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            el.style.display = <span class="hljs-string">'block'</span>;
        };

        reader.onload = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
            <span class="hljs-keyword">if</span> (window.DOMParser) {
                parser = <span class="hljs-keyword">new</span> DOMParser();
                doc = parser.parseFromString(e.target.result, <span class="hljs-string">'text/xml'</span>);
            } <span class="hljs-keyword">else</span> {
                doc = <span class="hljs-keyword">new</span> ActiveXObject(<span class="hljs-string">'Microsoft.XMLDOM'</span>);
                doc.async = <span class="hljs-string">'false'</span>;
                doc.loadXML(e.target.result);
            }

            doc = parser.parseFromString(e.target.result, <span class="hljs-string">'application/xml'</span>);
            <span class="hljs-keyword">if</span> (!doc || doc.documentElement.tagName !== <span class="hljs-string">'gpx'</span>) {
                alert(fileinfo[<span class="hljs-number">0</span>].name + <span class="hljs-string">' in an invalid file.'</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }

            <span class="hljs-keyword">var</span> size = fileinfo[<span class="hljs-number">0</span>].size,
                unitCount = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">while</span> (size &gt;= <span class="hljs-number">1024</span>) {
                size = size / <span class="hljs-number">1024</span>;
                ++unitCount;
            }

            Output(fileinfo[<span class="hljs-number">0</span>].name + <span class="hljs-string">' ('</span> + size.toFixed(<span class="hljs-number">2</span>) + unitType[unitCount] + <span class="hljs-string">')'</span>);
            display(doc);
        };

        reader.onloadend = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            el.style.display = <span class="hljs-string">'none'</span>;
        };

        reader.readAsText(file, <span class="hljs-string">'UTF-8'</span>);
    };

    <span class="hljs-keyword">var</span> FileSelectHandler = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>fetch FileList object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> files = e.target.files || e.dataTransfer.files;</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>process all File objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        _.each(files, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value)</span> {</span>
            ParseFile(value);
        });

    };</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>call initialization file</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (window.File &amp;&amp; window.FileList &amp;&amp; window.FileReader) {
        document.getElementById(<span class="hljs-string">'files'</span>).addEventListener(<span class="hljs-string">'change'</span>, FileSelectHandler, <span class="hljs-literal">false</span>);
    } <span class="hljs-keyword">else</span> {
        alert(<span class="hljs-string">'Your browser doesn\'t support this feature, please upgrade it (or use Firefox or Chrome).'</span>);
    }

    window.onload = load();
})(_);</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
